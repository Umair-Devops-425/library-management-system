name: CI Pipeline
on:
  push:
    branches: [master]
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create .env file
      run: |
        echo "FLASK_ENV=production" >> .env
        echo "DB_USER=lmsuser" >> .env
        echo "DB_PASSWORD=lms123" >> .env
        echo "DB_NAME=lms" >> .env
        echo "DB_PORT=3306" >> .env
        echo "MYSQL_HOST=mysql" >> .env
    
    - name: Login to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
    
    - name: Build and Push app image
      run: |
        # Build the app service
        docker compose build app
        
        # Get the actual project name (Docker Compose uses directory name with hyphens)
        PROJECT_NAME=$(basename $(pwd) | tr '[:upper:]' '[:lower:]' | tr '_' '-')
        BUILT_IMAGE="${PROJECT_NAME}-app"
        
        echo "Built image name: $BUILT_IMAGE"
        
        # Verify the image exists
        docker images | grep app
        
        # Tag with your Docker Hub username
        docker tag $BUILT_IMAGE ${{ secrets.DOCKER_USERNAME }}/app:latest
        docker tag $BUILT_IMAGE ${{ secrets.DOCKER_USERNAME }}/app:v2
        
        # Push both tags
        docker push ${{ secrets.DOCKER_USERNAME }}/app:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/app:v2